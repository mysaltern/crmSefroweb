//Copyright (c) MIT 2016-2017 Rafal Marguzewicz pceuropa.net
"use strict";var MyMENU=MyMENU||{};MyMENU=function(){function a(a){a.config=a.config||{},this.config={prefixDelete:"prefixDelete"},this.config.getMysql=a.config.getMysql||!1,this.config.setMysql=a.config.setMysql||!1,this.navbar={left:[],right:[]},this.navbar=this.mysql("get")||this.navbar,this.init()}return a.prototype={version:"2.1.3",operations:0,location_selector:$("#location"),init:function(){var a=this;$("#type").on("change",function(){var b=$("#url-box, #anchor-box, #icon-box");switch(a.location_selector.empty().append(a.locations()),b.show(),!0){case"dropmenu"==$(this).val():$("#url-box").hide();break;case"line"==$(this).val():b.hide();break;default:b.show()}}),a.location_selector.on("change",function(){var a="#"+$(this).val();$(a).css({border:"0 solid #f37736"}).animate({borderWidth:1},3e3,"swing",function(){$(a).animate({borderWidth:0},1e3)})}),$("#menu-create").click(function(){a.mysql("set")}),$("#add").click(function(){var b=a.sourceElement();a.addToMenu(b)})},addToMenu:function(a){var a=a||{type:"link",location:"left",label:"error",url:"/menu/index",icon:""},b={};switch(a.side=this.sideNav(a.location),a.type){case"link":b={label:a.label,url:a.url,icon:a.icon,type:"link"},"left"==a.location||"right"==a.location?this.navbar[a.location].push(b):this.navbar[a.side][a.location[1]].items.push(b);break;case"dropmenu":this.navbar[a.location].push({label:a.label,items:[],icon:a.icon,type:"dropmenu"});break;case"line":this.navbar[a.side][a.location[1]].items.push({type:"line",label:""});break;default:window.console&&console.log("error side")}this.render()},mysql:function(a){var b=this,a=a||"get";if("get"==a){if(!this.config.getMysql)return!1;window.console&&console.log(a),$.getJSON(document.URL,function(a){b.navbar=JSON.parse(a.menu),b.render()})}else{if(0==this.operations)return b.operations++,!1;$.ajax({url:document.URL,type:"post",dataType:"JSON",data:{update:!0,_csrf:b.csrfToken,menu:JSON.stringify(b.navbar,null,4)},success:function(a){a.success===!1&&window.console&&console.log(a.message),a.success===!0&&(window.console&&console.log(b.operations+". save correct"),b.afterSuccessSave(),b.operations++)},error:function(a,b,c){alert(b)}})}},afterSuccessSave:function(){var a=$("#add"),b=a.html();window.setTimeout(function(){a.prop("disabled",!0).text("Menu saved correctly")},111),window.setTimeout(function(){a.prop("disabled",!1).html(b)},1111)},filter:function(){function b(b){return b!==a.config.prefixDelete}function c(a){return"line"!==a.type}function d(a){return void 0!==a.label||"string"==typeof a}var a=this;this.navbar.left=this.navbar.left.filter(b).filter(c).filter(d),this.navbar.right=this.navbar.right.filter(b).filter(c).filter(d);for(var e=this.navbar.left.length;e--;)this.navbar.left[e].hasOwnProperty("items")&&(this.navbar.left[e].items=this.navbar.left[e].items.filter(b).filter(d));for(var e=this.navbar.right.length;e--;)this.navbar.right[e].hasOwnProperty("items")&&(this.navbar.right[e].items=this.navbar.right[e].items.filter(b).filter(d))},render:function(){window.console&&console.log("render"),this.filter(),$("#left").empty().append(this.renderNavbar("left")),$("#right").empty().append(this.renderNavbar("right")),console.log(this.locations()),this.location_selector.empty().append(this.locations()),this.sort(),this.config.setMysql&&this.mysql("set")},jsonPreview:function(){$("#code code").text(JSON.stringify(this.navbar,null,4))},locations:function(){var a=$("#type").val(),b='<option value="left">Navbar Left</option><option value="right">Navbar Right</option>';if("dropmenu"!=a){"line"==a&&(b="");for(var c=0;c<this.navbar.left.length;c++)this.navbar.left[c].hasOwnProperty("items")&&(b+='<option value="l'+c+'">Dropmenu: '+this.navbar.left[c].label+"</option>");for(var c=0;c<this.navbar.right.length;c++)this.navbar.right[c].hasOwnProperty("items")&&(b+='<option value="r'+c+'">Dropmenu: '+this.navbar.right[c].label+"</option>")}return b},renderNavbar:function(a){var b=$("#"+a),c=this.navbar[a],d=this;return $.map(c,function(c,e){switch(c.type){case"dropmenu":b.append(d.dropmenu(c,a[0]+e));break;case"link":b.append(d.link(c));break;case"line":b.append(d.divider(c));break;default:window.console&&console.log("Element type error")}}),b},icon:function(a){var b="";return a&&(b=$("<span />").addClass("glyphicon").addClass("glyphicon-"+a)),b},divider:function(a){var b=$("<li />");return b.addClass("divider"),b},link:function(a){var b=$("<a />",{href:a.url}).text(a.label);b.prepend(this.icon(a.icon));var c=$("<li />").append(b);return c},dropmenu:function(a,b){var c,d=$("<ul />",{id:b}).addClass("dropdown-menu"),e=this;return $.map(a.items,function(a){d.append(e.link(a))}),c=$("<li />").addClass("pceuropa-dropmenu").attr("data-dropmenu","true"),c.append($("<a />").addClass("dropdown-toggle").attr("data-toggle","dropdown").attr("draggable","false").attr("aria-expanded","false").text(a.label).prepend(this.icon(a.icon)).append($("<span />").addClass("caret"))),c.append(d),c},previewTest:function(){return["normal","json","yii2"]},arrayGroups:function(){var a=[],b=0;for(b=this.navbar.left.length;b--;)this.navbar.left[b].hasOwnProperty("items")&&a.push("l"+b);for(b=this.navbar.right.length;b--;)this.navbar.right[b].hasOwnProperty("items")&&a.push("r"+b);return a||[]},sourceElement:function(){var a={};return $("#inputsData input, #inputsData select").filter(function(){return 0!==this.value.length}).each(function(){a[this.id]=$(this).val()}),a},sideNav:function(a){return"r"==a[0]?"right":"left"},sort:function(){var a=this,b={group:"nav",animation:0,ghostClass:"ghost",onMove:function(a){a.from.id,a.target.id,a.oldIndex,a.newIndex;"true"!=a.dragged.dataset.dropmenu&&$(".pceuropa-dropmenu").addClass("open")},onUpdate:function(b){var c=b.from.id,d=b.oldIndex,e=b.newIndex,f="left";"left"==c||"right"==c?a.navbar[c].move(d,e):(f=a.sideNav(c),a.navbar[f][c[1]].items.move(d,e)),setTimeout(a.render(),300)},onAdd:function(b){var c=b.from.id,d=b.target.id,e=b.oldIndex,f=b.newIndex,g={},h={},i=function(a){var b={};if("string"==typeof a||a instanceof String)return b=a;for(var c in a)b[c]=a[c];return b};if("left"==c||"right"==c)g=i(a.navbar[c][e]),a.navbar[c][e]=a.config.prefixDelete;else{var j=a.sideNav(c);g=i(a.navbar[j][c[1]].items[e]),a.navbar[j][c[1]].items[e]=a.config.prefixDelete}if("left"==d||"right"==d)h=a.navbar[d];else{var j=a.sideNav(d);h=a.navbar[j][d[1]].items}h.splice(f,0,g),setTimeout(a.render(),300)}},c={group:"nav",onAdd:function(b){var c={},d=b.from.id,e=a.sideNav(d),f=b.oldIndex,g=$("#edit"),h=$("#inputsData, #trash"),i=function(a){return a?a:""},j=function(a,b,c){var d=$("<div />",{id:b+"-box-update"}).addClass("form-group"),e=$("<label />").addClass("col-sm-3 control-label").text(c),f=$("<div />").addClass("col-sm-8");return d.append(e).append(f.append(a))};$(".pceuropa-dropmenu").click(),c="left"==d||"right"==d?a.navbar[d][f]:a.navbar[e][d[1]].items[f],"line"!=c.type&&(g.attr("class","col-md-8 form-horizontal well"),g.append(j($("<input />",{id:"label-update",type:"text"}).val(i(c.label)).addClass("form-control input-sm"),"anchor","Text")),c.hasOwnProperty("items")||"line"==c.type||g.append(j($("<input />",{id:"url-update",type:"text"}).val(i(c.url)).addClass("form-control input-sm"),"url","URL")),window.console&&console.log(c),g.append(j($("<button />",{id:"btnUpdate"}).addClass("btn btn-warning").text("Update"),"save","")),h.hide(),$("#btnUpdate").click(function(){"line"!=c.type&&(c.label=$("#label-update").val(),$("#url-update").val()?c.url=$("#url-update").val():null),h.show(),g.attr("class","col-md-2 well").html("Drop here to edit"),a.render()}))}},d={group:"nav",animation:0,ghostClass:"ghost",onAdd:function(b){var c=b.from.id,d=b.oldIndex,e=$("#trash");$(".pceuropa-dropmenu").click(),e.append($("<button />",{type:"button",id:"cancel"}).addClass("btn btn-success").text("Cancel")).append($("<button />",{type:"button",id:"delete"}).addClass("btn btn-danger").text("Delete")),$("#cancel").click(function(){e.html("Drop here to trash"),a.render()}),$("#delete").click(function(){if("left"==c||"right"==c)a.navbar[c][d]=a.config.prefixDelete;else{var b=a.sideNav(c);a.navbar[b][c[1]].items[d]=a.config.prefixDelete}e.html("Drop here to trash"),a.render()})}};Sortable.create(left,b),Sortable.create(right,b),Sortable.create(trash,d),Sortable.create(edit,c),function(){var d,c=0,e=a.arrayGroups();for(c=e.length;c--;)d=document.getElementById(e[c]),Sortable.create(d,b)}()},test:function(){for(var a=0;a<4;a++)this.addToMenu({type:"link",location:"left",label:"link"+a,url:"/menu/index"}),this.addToMenu({type:"dropmenu",location:"right",label:"DropMenu"+a,items:[]});this.addToMenu({type:"link",location:"r0",label:"link1",url:"/menu/index"}),this.addToMenu({type:"link",location:"r0",label:"link2",url:"/menu/index"}),this.addToMenu({type:"link",location:"r0",label:"link3",url:"/menu/index"}),this.navbar.left.move(0,3),this.navbar.right[0].items.move(0,1),this.navbar.right.move(3,1),this.render()}},{Menu:a}}(),Array.prototype.move=function(a,b){if(b>=this.length)for(var c=b-this.length;c--+1;)this.push(void 0);return this.splice(b,0,this.splice(a,1)[0]),this};
